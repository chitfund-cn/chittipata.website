<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chittipata | Plans</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="plans.html" class="active">Plans</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
  </nav>
  <main>
    <section id="plansSection">
      <h1>Select Your Plan</h1>
      <div id="userDashboard" style="display:none"></div>
      <div class="plan-cards" id="planSelection">
        <div class="plan-card" onclick="startRegistration('₹500 / Month',500)">
          <h2>₹500 / Month</h2>
          <p>Save ₹500 every month</p>
          <p>Get ₹5,000 after 11 months</p>
          <p>Get ₹10,000 after 22 months</p>
        </div>
        <div class="plan-card" onclick="startRegistration('₹1,000 / Month',1000)">
          <h2>₹1,000 / Month</h2>
          <p>Save ₹1,000 every month</p>
          <p>Get ₹10,000 after 11 months</p>
          <p>Get ₹20,000 after 22 months</p>
        </div>
      </div>
      <div class="note">
        <b>Note:</b> Withdraw before tenure? Only 40% of listed return is paid. Full returns only after tenure completion.
      </div>
    </section>
  </main>
  <!-- Registration Modal -->
  <div id="regModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('regModal')">&times;</span>
      <h2>Register / Login</h2>
      <form id="regForm" autocomplete="off">
        <label for="planAmount">Plan Amount</label>
        <input type="text" id="planAmount" name="planAmount" readonly>
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" required>
        <label for="mobile">Mobile Number</label>
        <input type="tel" id="mobile" required pattern="[0-9]{10}" maxlength="10">
        <label for="email">Email ID</label>
        <input type="email" id="email" required>
        <label for="address">Address</label>
        <input type="text" id="address" required>
        <label for="tenure">Select Tenure</label>
        <select id="tenure" required>
          <option value="">Select</option>
          <option value="11">11 Months</option>
          <option value="22">22 Months</option>
        </select>
        <button type="submit">Send OTP</button>
      </form>
    </div>
  </div>
  <!-- OTP Modal -->
  <div id="otpModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('otpModal')">&times;</span>
      <h2>OTP Verification</h2>
      <form id="otpForm" autocomplete="off">
        <label for="otp">Enter OTP sent to your mobile</label>
        <input type="text" id="otp" required maxlength="6" pattern="[0-9]{6}">
        <button type="submit">Verify OTP</button>
      </form>
      <div id="otpStatus"></div>
    </div>
  </div>
  <!-- Payment Modal -->
  <div id="payModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('payModal')">&times;</span>
      <h2>Make Your Payment</h2>
      <div id="payDetails"></div>
      <div class="upi-options">
        <h3>Pay via UPI Number or Scan QR</h3>
        <p><b>UPI ID:</b> 9059076269@upi</p>
        <img id="upiQR" src="" alt="UPI QR" width="180" style="margin:10px auto;">
        <p>Amount: <span id="paymentAmount"></span> (locked)</p>
        <button onclick="paymentDone()">I have Paid</button>
      </div>
    </div>
  </div>
  <script>
    // Local storage keys for demo persistence
    const LS_USER = "cp_user";
    const LS_PAYMENTS = "cp_payments";
    // State
    let selectedPlan = null, selectedAmount = 0, selectedTenure = 0, regData = {};

    // On load, check session
    window.onload = function() {
      if(localStorage.getItem(LS_USER)) {
        showDashboard();
      }
    }

    function startRegistration(plan, amount) {
      selectedPlan = plan;
      selectedAmount = amount;
      document.getElementById("planAmount").value = plan;
      document.getElementById("regModal").style.display = "block";
    }
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
      if(id==="regModal") document.getElementById("regForm").reset();
      if(id==="otpModal") document.getElementById("otpForm").reset();
    }

    // Registration form submission
    document.getElementById("regForm").onsubmit = function(e) {
      e.preventDefault();
      // Simulate backend: save registration and send OTP
      regData = {
        plan: selectedPlan,
        amount: selectedAmount,
        fullName: document.getElementById("fullName").value,
        mobile: document.getElementById("mobile").value,
        email: document.getElementById("email").value,
        address: document.getElementById("address").value,
        tenure: document.getElementById("tenure").value
      };
      // Backend: Send OTP to regData.mobile here!
      closeModal('regModal');
      document.getElementById('otpModal').style.display = "block";
      // For demo: set correct OTP as 123456
      sessionStorage.setItem("cp_otp", "123456");
    }

    // OTP verification
    document.getElementById("otpForm").onsubmit = function(e) {
      e.preventDefault();
      const userOtp = document.getElementById("otp").value;
      const realOtp = sessionStorage.getItem("cp_otp");
      if(userOtp === realOtp) {
        // Backend: register user session, clear OTP, send login tokens, etc.
        localStorage.setItem(LS_USER, JSON.stringify(regData));
        closeModal('otpModal');
        showPayment();
      } else {
        document.getElementById("otpStatus").innerText = "Incorrect OTP. Try again.";
      }
    }

    // Payment Modal
    function showPayment() {
      document.getElementById("payModal").style.display = "block";
      document.getElementById("payDetails").innerHTML = `
        <p><b>Plan:</b> ${regData.plan}</p>
        <p><b>Tenure:</b> ${regData.tenure} months</p>
        <p><b>Name:</b> ${regData.fullName}</p>
        <p><b>Mobile:</b> ${regData.mobile}</p>
      `;
      document.getElementById("paymentAmount").innerText = "₹" + regData.amount;
      // Generate UPI QR
      let upiUrl = `upi://pay?pa=9059076269@upi&pn=Chittipata&am=${regData.amount}&cu=INR`;
      document.getElementById("upiQR").src = "https://api.qrserver.com/v1/create-qr-code/?data=" + encodeURIComponent(upiUrl) + "&size=180x180";
    }

    // Payment complete
    function paymentDone() {
      // Backend: verify payment & send email receipts to regData.email and all managing emails!
      // For demo: Save payment record, update dashboard
      let payments = JSON.parse(localStorage.getItem(LS_PAYMENTS) || "[]");
      const now = new Date();
      const dueDate = new Date(now.setMonth(now.getMonth() + 1));
      payments.push({
        mobile: regData.mobile,
        plan: regData.plan,
        amount: regData.amount,
        tenure: regData.tenure,
        paidOn: new Date().toLocaleDateString(),
        nextDue: dueDate.toLocaleDateString()
      });
      localStorage.setItem(LS_PAYMENTS, JSON.stringify(payments));
      closeModal('payModal');
      alert("Payment successful! Receipts will be sent via email after verification.");
      showDashboard();
    }

    // User dashboard after login/payment
    function showDashboard() {
      document.getElementById("planSelection").style.display = "none";
      let user = JSON.parse(localStorage.getItem(LS_USER));
      let payments = JSON.parse(localStorage.getItem(LS_PAYMENTS) || "[]").filter(p=>p.mobile===user.mobile);
      let paidCount = payments.length;
      let tenure = +user.tenure;
      let due = "No payments yet";
      if(paidCount>0) due = payments[payments.length-1].nextDue;
      document.getElementById("userDashboard").style.display = "block";
      document.getElementById("userDashboard").innerHTML = `
        <div class="dashboard">
          <h2>Welcome, ${user.fullName}!</h2>
          <p>Your Plan: <b>${user.plan}</b></p>
          <p>Tenure: <b>${user.tenure} months</b></p>
          <p>Payments Made: <b>${paidCount}</b></p>
          <p>Remaining Payments: <b>${tenure-paidCount}</b></p>
          <p>Next Due Date: <b>${due}</b></p>
          <button onclick="makePayment()">Pay Next Due</button>
          <button onclick="logout()" style="background:#c35400;">Logout</button>
        </div>
      `;
    }
    function makePayment() {
      // Show payment modal with locked amount
      let user = JSON.parse(localStorage.getItem(LS_USER));
      regData = user;
      showPayment();
    }
    function logout() {
      localStorage.removeItem(LS_USER);
      document.getElementById("userDashboard").style.display = "none";
      document.getElementById("planSelection").style.display = "flex";
    }
  </script>
</body>
</html>
